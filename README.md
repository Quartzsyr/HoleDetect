## 项目简介

**OCT 孔洞检测与测量工具**是一个基于 **PyQt5 + OpenCV** 的桌面应用，用于对 OCT/显微成像中的孔洞进行自动检测、尺寸测量与可视化分析，并支持：

- 孔洞几何尺寸（直径、深度等）的自动测量与结果可视化
- 像素到微米的标定（独立像素校准工具）
- 多张 OCT 图像的 3D 圆孔重建（OCT 圆孔重建模块）
- 支持图像裁剪、手动测量、调参微调和调试输出

项目同时提供可执行安装包（`孔洞检测程序.exe` / `孔洞测量安装包*.exe`），也可以直接通过 Python 源码运行，方便二次开发和集成。

---

## 开发者信息

- 开发者：石殷睿（苏州大学）
- 邮箱：SYRQuartz@gmail.com
- 项目背景：光电设计大赛参赛作品

---

## 功能总览

- **主程序：孔洞检测与测量（`hole_detection_qt.py`）**
  - 加载单张孔洞图像（支持常见格式：JPG/PNG 等）
  - 自动定位孔洞区域，检测顶部、底部、缺口等关键结构
  - 自动计算：
    - **直径（μm）**
    - **深度（μm）**
    - 其他派生指标（如上/下方标准位置直径、深径比等，视参数开启情况而定）
  - 支持多种测量模式：
    - 自动测量模式
    - 无缺口测量模式
    - 手动测量模式（通过鼠标点选/拖动示波器样式线）
  - 支持图像裁剪（聚焦 ROI 区域）
  - 内置调试输出（保存中间结果到 `debug/` 目录，便于算法分析与调参）

- **像素标定工具（`pixel_calibration.py`）**
  - 通过两块已知物理间距的白色区域，自动计算：
    - 中心间像素距离
    - 像素 → 微米 转换系数
  - 支持交互调整：二值阈值、最小区域面积、已知物理距离等
  - 可保存处理结果图与标定数据

- **OCT 圆孔重建模块（`oct_module.py` + `oct_utils.py`）**
  - 在 UI 中加载多张 OCT 图像
  - 手动在每张图像上标记圆孔直径两端点
  - 将所有 2D 测量点与扫描位置转换为 3D 空间点
  - 通过平面拟合 + 圆拟合获取真实 3D 圆孔直径
  - 支持 3D 可视化展示
  - 详细集成方式见 `integration_guide.md`

---

## 目录结构（核心部分）

- `hole_detection_qt.py`：主界面与主检测逻辑（推荐入口）
- `oct_module.py` / `oct_utils.py`：OCT 圆孔重建相关 UI 和算法
- `pixel_calibration.py`：像素标定工具
- `input/`：默认输入图像目录（可自行放测量用图像）
- `output/`：测量/处理结果输出目录（含覆盖结果图等）
- `debug/`：中间过程图像与调试图输出目录
- `build/`、`dist/`：打包/构建产物目录
- `孔洞检测程序.exe`、`孔洞测量安装包*.exe`：Windows 可执行程序及安装包（历史版本）
- `integration_guide.md`：将 OCT 圆孔重建功能集成进主程序的说明
- `pixel_conversion_instructions.md` 及相关文档：像素转换/标定的设计说明

---

## 环境与依赖

- **Python**：推荐 Python 3.8+
- **主要依赖库**（通过 `pip` 安装）：

```bash
pip install \
  opencv-python \
  numpy \
  pandas \
  matplotlib \
  scikit-learn \
  pillow \
  PyQt5
```

> 如在国内环境中安装依赖失败，可配置镜像源（如清华源）后重试。

---

## 快速开始

### 1. 克隆代码

```bash
git clone <your-repo-url>.git
cd opencvinno  # 或对应的项目目录名
```

### 2. 安装依赖

```bash
pip install -r requirements.txt  # 如果你创建了此文件
```

如未维护 `requirements.txt`，可直接按上一节的依赖列表手动安装。

### 3. 运行主程序（孔洞检测）

```bash
python hole_detection_qt.py
```

运行后将弹出主界面，核心操作流程：

1. **加载图像**：从菜单或按钮选择待测孔洞图像
2. **选择模式**：
   - 默认自动测量模式
   - 如需手动干预，可开启手动测量或无缺口测量模式
3. **调整参数**（如有需要）：
   - 可通过 UI 中的滑块/微调框修改高斯核大小、阈值、搜索范围等参数
   - 也可打开微调对话框（`FineTuneDialog`）查看调参预览
4. **查看结果**：
   - 右侧或底部区域显示检测结果图与测量数值（直径、深度等）
   - 同时在 `output/`、`debug/` 中生成对应图像

---

## 像素标定工具使用说明（`pixel_calibration.py`）

像素标定用于将图像像素尺寸转换为真实物理尺寸（微米），建议在正式批量测量前完成一次标定。

### 启动

```bash
python pixel_calibration.py
```

### 使用步骤

1. **加载图像**：点击“加载图像”，选择一张包含 **两块已知间距白色区域** 的图像
2. **调整参数**：
   - **二值化阈值**：控制黑白分割
   - **最小区域大小**：过滤噪声小区域
   - **已知距离**：输入两白色区域真实间距（单位：微米），默认为 1000 μm（1 mm）
3. **处理图像**：点击“处理图像”
4. 在界面上查看：
   - 像素距离（px）
   - 像素 → 微米 转换比例（μm/px）
5. **保存结果**：可将处理后图像与标定结果数据保存至本地

### 使用建议

- 确保两块白色区域边缘清晰、对比度足够
- 若未能正确检测出区域，可适当调高/调低阈值或调整最小区域大小
- 标定完成后，可将比例应用到主程序中（例如配置 `PIXEL_TO_UM_X`、`PIXEL_TO_UM_Y` 等）

---

## OCT 圆孔重建功能

OCT 圆孔重建模块用于在多张 OCT 截面图的基础上，重建真实三维圆孔并计算真实直径。

### 集成方式（简要）

主程序中已经通过：

- `import oct_module`
- 在菜单栏中添加 **“OCT圆孔重建”** 菜单项

来对接 `OCTHoleReconstructionDialog` 对话框。更详细的集成步骤和问题排查见 `integration_guide.md`。

### 使用流程概述

1. 在主程序菜单中选择：**分析 → OCT圆孔重建**
2. 在弹出的对话框中：
   - 添加多张 OCT 图像
   - 在每张图像上分别标记圆孔直径两端点
3. 点击“开始重建”：
   - 程序将所有 2D 端点转换为 3D 点
   - 使用 SVD 等方法拟合平面并在平面内拟合圆
4. 查看：
   - 真实 3D 直径数值
   - 3D 可视化结果

---

## 调试与结果输出

- **输入目录（`input/`）**：
  - 默认图像读取目录，可放待处理 OCT/显微图像
- **输出目录（`output/`）**：
  - 存储最终测量结果图、合成图等
  - 示例：`hole_detection_result.jpg`、`merged_noise_image.jpg` 等
- **调试目录（`debug/`）**：
  - 存储中间过程图像（如二值化结果、行投影、列投影、候选直线等）
  - 方便分析测量失败原因与调整参数

---

## 打包与发布（可选）

项目中已包含：

- `hole_detection_qt.spec`：用于 `PyInstaller` 打包的配置文件
- `inno_setup_script.iss`：Windows 安装包（Inno Setup）脚本

如需自行生成 `.exe` 或安装包，可参考这些文件进行构建。

示例（仅供参考，具体以本机环境为准）：

```bash
pyinstaller hole_detection_qt.spec
```

然后使用 Inno Setup 打开 `inno_setup_script.iss` 生成安装程序。

---

## 备注

- 当前仓库包含大量用于修复/调试的脚本（如 `fix_*.py`、`simple_patch.py` 等），主要是开发过程的辅助工具，**正常使用时无需运行**。
- 如需在其他项目中集成本工具的算法模块，可优先参考：
  - `hole_detection_qt.py` 中的图像处理与测量流程
  - `oct_utils.py` 中的几何/拟合算法实现
  - `pixel_calibration.py` 中的标定逻辑

欢迎根据实际业务需求进行二次开发与改造。
